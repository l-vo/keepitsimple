
<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
  <title>Sécuriser ses conteneurs Docker en production | Keep it simple. Stupid.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Docker est à l’origine conçu pour créer des conteneurs à la volée et effectuer des developpements/tests dans différents environments. Mais sa simplicité d’utilisation et son écosystème grandissant pou">
<meta name="keywords" content="Docker">
<meta property="og:type" content="article">
<meta property="og:title" content="Sécuriser ses conteneurs Docker en production">
<meta property="og:url" content="http://keepitsimple.l-vo.fr/2018/07/19/Securiser-ses-conteneurs-Docker-en-production/index.html">
<meta property="og:site_name" content="Keep it simple. Stupid.">
<meta property="og:description" content="Docker est à l’origine conçu pour créer des conteneurs à la volée et effectuer des developpements/tests dans différents environments. Mais sa simplicité d’utilisation et son écosystème grandissant pou">
<meta property="og:locale" content="fr-FR">
<meta property="og:updated_time" content="2018-09-30T11:18:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sécuriser ses conteneurs Docker en production">
<meta name="twitter:description" content="Docker est à l’origine conçu pour créer des conteneurs à la volée et effectuer des developpements/tests dans différents environments. Mais sa simplicité d’utilisation et son écosystème grandissant pou">
  
    <link rel="alternative" href="/atom.xml" title="Keep it simple. Stupid." type="application/atom+xml">
  

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/style.css">
  
    
  
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-116065119-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->

  

</head>
</html>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <nav id="upper-nav" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <div class="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        
          <a id="nav-github" class="nav-icon" href="https://github.com/l-vo"></a>
        
      </div>
    </nav>
    <div id="header-title">
      
        <h1 id="blog-title-wrap">
          <a href="/" id="blog-title">Keep it simple. Stupid.</a>
        </h1>
      
    </div>
    <div id="contenedor"></div>
    <nav id="main-nav">
      
        <a class="main-nav-link" href="/">Accueil</a>
      
        <a class="main-nav-link" href="/archives">Archives</a>
      
        <a class="main-nav-link" href="/a-propos">A propos</a>
      
      <a class="main-nav-link" href="/rechercher" id="search-link">Rechercher</a>
    </nav>
  </div>
</header>

    <div class="outer">
      <section id="main"><article id="post-Securiser-ses-conteneurs-Docker-en-production" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2018/07/19/Securiser-ses-conteneurs-Docker-en-production/" class="article-date">
  <time datetime="2018-07-19T09:18:20.000Z" itemprop="datePublished">19/07/2018</time>
</h3>
    
  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Sécuriser ses conteneurs Docker en production
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>Docker est à l’origine conçu pour créer des conteneurs à la volée et effectuer des developpements/tests dans différents environments. Mais sa simplicité d’utilisation et son écosystème grandissant pousse de plus en plus ses adeptes à vouloir l’utiliser en prod. D’autant que de nouveaux outils (Kubernetes, Swarm…) et des améliorations récentes (user namespaces, variables d’environnement dans les docker-compose…) vont dans ce sens.  </p>
<p>Malheureusement les conteneurs Docker sont de base assez peu sécurisés. Nous allons<br>voir quelques astuces simples pour limiter les possibilités d’attaques lorsque vous déploierez vos conteneurs en production. </p>
<a id="more"></a>
<p>Tout d’abord je vous recommande la lecture de cette article: <a href="https://w3blog.fr/2016/02/23/docker-securite-10-bonnes-pratiques/" target="_blank" rel="noopener">https://w3blog.fr/2016/02/23/docker-securite-10-bonnes-pratiques/</a>. Bien que datant un peu, les préceptes qu’il aborde sont encore d’actualité. Je vais essayer de le compléter par quelques autres conseils pour sécuriser votre conteneur.</p>
<h2 id="Supprimer-la-creation-automatique-de-regles-iptables"><a href="#Supprimer-la-creation-automatique-de-regles-iptables" class="headerlink" title="Supprimer la création automatique de règles iptables"></a>Supprimer la création automatique de règles iptables</h2><p>Par défaut, le daemon Docker créé les règles iptables dont il a besoin. Mais si vous êtes sur un système hôte avec plusieurs conteneurs et que vous le sécurisez via iptables et fail2ban (ou équivalent), vous allez vouloir garder le contrôle sur les règles qui vont être créées dans votre iptables. Celà se fait en modifiant les options du service Docker:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS=&quot;--iptables=false&quot;</span><br></pre></td></tr></table></figure></p>
<p>Attention, lorsque vous modifiez les options du daemon, vous aurez la mauvaise surprise de voir que tous vos conteneurs, volumes etc sont à recréer. Vous pouvez les retrouver en revenant aux anciennes options du daemon; mais à garder à l’esprit si vous aviez prévu de faire cette modif en prod sans interruption de service.</p>
<h2 id="Utiliser-les-user-namespaces"><a href="#Utiliser-les-user-namespaces" class="headerlink" title="Utiliser les user namespaces"></a>Utiliser les user namespaces</h2><p>Un des problèmes innérants à la sécurité de Docker est le fait que les conteneurs tournent par defaut sur l’utilisateur root. Ce qui signifie que l’utilisateur root dans vos conteneurs a potentiellement les privilèges de l’utilisateur root de votre machine hôte. Oui, ça fait peur. Mais ça c’étant avant la mise en place sur Docker des user namespaces. Les user namespaces vont permettre de mapper les utilisateurs de vos conteneurs à des utilisateurs avec des privilèges plus limités sur votre système hôte. Là encore, la modification s’effectue via les options du daemon Docker:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS=&quot;--userns-remap=default&quot;</span><br></pre></td></tr></table></figure></p>
<p>Une plage d’identifiants va être affecté à l’user/group dockremap dans les fichiers <code>/etc/subuid</code> et <code>/etc/subgid</code> de votre machine hôte et correspondront aux utilisateurs à l’intérieur de vos conteneurs. Un nom d’utilisateur autre que <code>dockremap</code> peut être utilisé si vous le specifiez comme valeur de <code>--userns-remap</code>à la place de <code>default</code>.</p>
<h2 id="Directive-USER-dans-les-Dockerfile"><a href="#Directive-USER-dans-les-Dockerfile" class="headerlink" title="Directive USER dans les Dockerfile"></a>Directive USER dans les Dockerfile</h2><p>Vous avez maintenant quelques astuces pour protéger mieux vos conteneurs. Mais si vous publiez une image de conteneur “production ready”, la personne qui va la déployer aura-t-elle utilisé les user namespaces ? Une image Docker ayant pour but d’être déployé en production ne devrait jamais démarrer sous l’utilisateur root. Ceci est possible via la directive <code>USER</code> mais on trouve finalement sur le net assez peu d’exemples d’utilisation de cette directive dans le but de sécuriser un conteneur. Voyons voir si nous voulons par exemple créer une image d’un conteneur MySQL sécurisé:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:trusty</span><br><span class="line"></span><br><span class="line"><span class="comment"># Des instructions...</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># On cré un utilisateur aux droits limités</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> adduser --disabled-password --gecos <span class="string">""</span> user1</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># On utilise cet utilisateur</span></span><br><span class="line"><span class="keyword">USER</span> user1</span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"mysqld_safe"</span>]</span></span><br></pre></td></tr></table></figure>
<p>Et là on se rend compte que user1 n’a pas les privilèges pour lancer mysqld_safe. Une astuce va donc être d’autoriser user1 à lancer mysqld_safe via le fichier <code>sudoers</code>:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:trusty</span><br><span class="line"></span><br><span class="line"><span class="comment"># Des instructions...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># On cré un utilisateur aux droits limités</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> adduser --disabled-password --gecos <span class="string">""</span> user1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># On autorise user1 à lancer mysqld_safe</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"user1 ALL = (root) NOPASSWD: /usr/bin/mysqld_safe"</span> &gt;&gt; /etc/sudoers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># On utilise cet utilisateur</span></span><br><span class="line"><span class="keyword">USER</span> user1</span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"sudo"</span>, <span class="string">"mysqld_safe"</span>]</span></span><br></pre></td></tr></table></figure>
<p>Le conteneur tourne à présent sous l’utilisateur user1 qui n’a de privilèges que pour lancer mysqld_safe. Si vous rentrez dans le conteneur via <code>docker exec</code>, vous êtes connecté via user1 ce qui limite grandement les possibilités d’une personne mal intentionnée.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Voilà, l’écosystème de Docker en continuelle évolution pousse de plus en plus vers une utilisation en production (et de nombreuses plus ou moins grosses sociétés ont déjà franchi le pas). Il ne faut cependant pas négliger la sécurité qui n’est pas moins importante ou plus facile à mettre en place que dans un système traditionnel sans conteneurs.</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li></ul>

        <a data-url="http://keepitsimple.l-vo.fr/2018/07/19/Securiser-ses-conteneurs-Docker-en-production/" data-id="cjszzg8t8000210qtka1fsnt3" class="article-share-link">Partager</a>
        
          <a href="http://keepitsimple.l-vo.fr/2018/07/19/Securiser-ses-conteneurs-Docker-en-production/#disqus_thread" class="article-comment-link">Commentaires</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/08/16/Partager-des-volumes-Docker-via-AFP-sur-OS-X/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Plus récent</strong>
      <div class="article-nav-title">
        
          Partager des volumes Docker via AFP sur Mac
        
      </div>
    </a>
  
  
    <a href="/2018/04/28/Installer-une-galerie-photo-Piwigo-sur-Raspberry-PI/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Plus ancien</strong>
      <div class="article-nav-title">Installer une galerie photo (Piwigo) sur Raspberry PI</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/03/08/Installer-un-serveur-mail-sur-Debian-9-Stretch/">Installer un serveur mail sur Debian 9 (Stretch)</a>
          </li>
        
          <li>
            <a href="/2019/02/20/Recycler-une-tablette-Android-en-cadre-photo/">Recycler une tablette Android en cadre photo</a>
          </li>
        
          <li>
            <a href="/2018/11/24/Patcher-avec-Composer/">Patcher avec Composer</a>
          </li>
        
          <li>
            <a href="/2018/08/16/Partager-des-volumes-Docker-via-AFP-sur-OS-X/">Partager des volumes Docker via AFP sur Mac</a>
          </li>
        
          <li>
            <a href="/2018/07/19/Securiser-ses-conteneurs-Docker-en-production/">Sécuriser ses conteneurs Docker en production</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composer/">Composer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raspberry-Pi/">Raspberry_Pi</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">mars 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">février 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">novembre 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">août 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">juillet 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">avril 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">mars 2018</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Laurent VOULLEMIER<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/sun11/hexo-theme-paperbox" target="_blank">Paperbox</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Accueil</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/a-propos" class="mobile-nav-link">A propos</a>
  
  <a href="/rechercher" class="mobile-nav-link st-search-show-outputs">Rechercher</a>
</nav>

  

<!-- totop start -->
<div id="totop">
	<a title="Vers le haut"></a>
</div>
<!-- totop end -->

<!-- swiftype search start -->

<!-- swiftype search end -->


<script>
  var disqus_shortname = 'keep-it-simple-stupid';
  
  var disqus_url = 'http://keepitsimple.l-vo.fr/2018/07/19/Securiser-ses-conteneurs-Docker-en-production/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//ghsite.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lrsjng.jquery-qrcode/0.12.0/jquery.qrcode.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/search.js"></script>
<script type="text/javascript">
     var search_path = "search.xml";
     if (search_path.length == 0) {
     	search_path = "search.xml";
     }
     var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
</script>
</div>
</body>
</html>
