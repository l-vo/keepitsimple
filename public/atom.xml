<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Keep it simple. Stupid.</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://keepitsimple.l-vo.fr/"/>
  <updated>2018-03-19T20:46:46.000Z</updated>
  <id>http://keepitsimple.l-vo.fr/</id>
  
  <author>
    <name>Laurent VOULLEMIER</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>YAML et in_array, mauvaise surprise</title>
    <link href="http://keepitsimple.l-vo.fr/2018/03/18/yaml-in_array/"/>
    <id>http://keepitsimple.l-vo.fr/2018/03/18/yaml-in_array/</id>
    <published>2018-03-18T20:40:13.000Z</published>
    <updated>2018-03-19T20:46:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>Je vais ici vous conter une petite mésaventure qui m’est arrivée sur une des applications de la société où je travaille. Nous avons un Yaml de configuration qui indique quels clients doivent passer par une action donnée. Le fichier a cette forme:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">targetedCustomers:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">auchan</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">leclerc</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">geant</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cora</span></span><br></pre></td></tr></table></figure></p><p>Ensuite, rien d’extraordinaire, on utilise in_array pour tester si le client courant est concerné par l’action proposée:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Some stuff for parsing Yaml before</span></span><br><span class="line"><span class="comment">// $targetedCustomers is worth ['auchan', 'leclerc', 'geant', 'cora'] </span></span><br><span class="line"><span class="keyword">if</span> (in_array($currentCustomer, $targetedCustomers)) &#123;</span><br><span class="line">  <span class="comment">// Execute the action</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Jusque là tout va bien. Mais récemment nous avons ajouté le client “yes”. Drôle de nom pour un client vous allez me dire. Il n’empêche.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">targetedCustomers:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">auchan</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">leclerc</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">geant</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cora</span></span><br><span class="line"><span class="bullet">  -</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure><p>Et tout d’un coup <strong>TOUS</strong> nos clients se sont mis à être elligibles pour l’action précédemment évoquée. Pas glop. Comment en est-on arrivé à ce résultat ?</p><h2 id="Yaml-et-ses-valeurs-reservees"><a href="#Yaml-et-ses-valeurs-reservees" class="headerlink" title="Yaml et ses valeurs resérvées"></a>Yaml et ses valeurs resérvées</h2><p>En Yaml, certaines valeurs sont automatiquement converties. La chaine de caractères “true” (peu importe la casse) devient le booléan true. De même pour la chaine “on”. Et aussi pour la chaine “yes”. Tiens ça se précise. Donc une fois parsé, notre Yaml devient:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">print_r($targetedCustomers);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Array(</span></span><br><span class="line"><span class="comment">  [0] =&gt; auchan,</span></span><br><span class="line"><span class="comment">  [1] =&gt; leclerc,</span></span><br><span class="line"><span class="comment">  [2] =&gt; geant,</span></span><br><span class="line"><span class="comment">  [3] =&gt; cora,</span></span><br><span class="line"><span class="comment">  [4] =&gt; 1</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p><p>Le premier reflèxe en voyant ce résultat est simplement de se dire que le client “yes” n’est pas dans le tableau donc ne sera jamais elligible. Sauf que le typage faible de php vient enfoncer le clou.</p><h2 id="Les-joies-du-typage-dynamique-de-PHP"><a href="#Les-joies-du-typage-dynamique-de-PHP" class="headerlink" title="Les joies du typage dynamique de PHP"></a>Les joies du typage dynamique de PHP</h2><p>Une des premières caractéristiques de PHP est son typage dynamique. Une caractéristique qui a toujours fait de PHP un language un peu à part où se côtoient des bidouilleurs parfois même non informaticiens et des professionnels pour qui ce language n’a aucun secret. La fonction in_array accepte un troisième paramètre qui permet de faire la recherche dans un tableau en vérifiant aussi le type. Voyons donc ce qui ce passe si on ne vérifie pas le type (ce qui est le comportement par defaut):<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// strict mode</span></span><br><span class="line">$test = [<span class="string">"auchan"</span>, <span class="string">"leclerc"</span>, <span class="keyword">true</span>];</span><br><span class="line"><span class="comment">// in_array("lidl", $test, true) =&gt; false</span></span><br><span class="line"><span class="comment">// in_array("auchan", $test, true) =&gt; true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// non strict mode (default behavior)</span></span><br><span class="line"><span class="comment">// in_array("lidl", $test) =&gt; true</span></span><br><span class="line">$test2 = [<span class="string">"auchan"</span>, <span class="string">"leclerc"</span>];</span><br><span class="line"><span class="comment">// in_array(true, $test2) =&gt; true</span></span><br></pre></td></tr></table></figure></p><p>Lorsque l’on n’est pas en mode strict, la conversion est à double sens. Si une valeur du tableau convertie dans le type de la valeur à rechercher correspond, on retourne true (ce qui est prévisible). Ce à quoi on s’attend moins, c’est que si la valeur à rechercher convertie dans le type d’une des valeur du tableau correspond à cette valeur, on retourne true aussi. A garder à l’esprit pour éviter ce genre de mésaventure…</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Je vais ici vous conter une petite mésaventure qui m’est arrivée sur une des applications de la société où je travaille. Nous avons un Ya
      
    
    </summary>
    
    
      <category term="PHP" scheme="http://keepitsimple.l-vo.fr/tags/PHP/"/>
    
  </entry>
  
</feed>
